name: MNISTCalculator
on:
  push:
    paths:
      - 'monticore/EmbeddedMontiArc/applications/MNISTCalculator/**'
  workflow_dispatch:
env:
  CI_PROJECT_ID : 25225
  CI_API_V4_URL : https://git.rwth-aachen.de/api/v4
  GITLABTOKEN : ${{ secrets.GITLABTOKEN }}
jobs:
  prebuild_phase:
    needs: [DeployMnistCalcArtifact]
    if: ${{ !cancelled()}}
    runs-on: ubuntu-latest
    steps:
        - run: |
            echo "Finished stage prebuild"
          if: ${{!contains(needs.*.result, 'failure')}}
        - run: |
            echo "Failed stage prebuild"
            exit 1
          if: ${{contains(needs.*.result, 'failure')}}
  test_phase:
    needs: [prebuild_phase, TrainTensorflowONNX, TrainHexadecimal_MnistCalculator, TrainOperator_MnistCalculator, TestEMADLMavenPlugin, TestMnistWithAdaNet, TestGluonONNX, DeployDecompositionResNetArtifact, TestMNISTwithCustomLayer, TrainHexadecimal_MnistCalculatorTL, TrainOperator_MnistCalculatorTL, TestMavenStreamtestPlugin, TestTENSORFLOW]
    if: ${{ !cancelled()}}
    runs-on: ubuntu-latest
    steps:
        - run: |
            echo "Finished stage test"
          if: ${{!contains(needs.*.result, 'failure')}}
        - run: |
            echo "Failed stage test"
            exit 1
          if: ${{contains(needs.*.result, 'failure')}}
  testmodular_phase:
    needs: [test_phase, TestModularModels, TestDecompositionResNet, TestTransfer, TestDecomposition]
    if: ${{ !cancelled()}}
    runs-on: ubuntu-latest
    steps:
        - run: |
            echo "Finished stage testmodular"
          if: ${{!contains(needs.*.result, 'failure')}}
        - run: |
            echo "Failed stage testmodular"
            exit 1
          if: ${{contains(needs.*.result, 'failure')}}

  TestTENSORFLOW:
    needs: prebuild_phase
    if: ${{ !cancelled() && !contains(needs.*.result, 'failure')       && github.ref != 'refs/heads/modular_testing'}}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout latest commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Restore large files
        run: |
          ls
          find . -type f -name '*.part*' | sort | while read part; do
          echo "Restoring $part"
          base=$(echo "$part" | sed 's/.part.*//')
          cat "$part" >> "$base"
          rm "$part"
          done
      - name: Start Docker Container
        run: |
          docker pull registry.git.rwth-aachen.de/monticore/embeddedmontiarc/applications/mnistcalculator/tensorflow
          docker run --name build-container -d -v $(pwd):/workspace --network=host  -e CI_API_V4_URL=$CI_API_V4_URL -e GITLABTOKEN=${{ secrets.GITLABTOKEN }} registry.git.rwth-aachen.de/monticore/embeddedmontiarc/applications/mnistcalculator/tensorflow tail -f /dev/null
      - name: Script
        env:
          SCRIPT: |
            cd /workspace
            cd monticore/EmbeddedMontiArc/applications/MNISTCalculator
            cd tensorflow
            chmod +x build.sh
            ./build.sh
            RES=$(./build/src/cpp/DigitCalculator resources/images/1.png resources/images/2.png resources/images/3.png resources/images/4.png resources/images/5.png resources/images/6.png)
            if [[ $RES != *"SUM: 579"* ]]; then echo "Wrong result:" $RES; exit 1; fi;
        run: docker exec build-container bash -c "$SCRIPT"

  TestMavenStreamtestPlugin:
    needs: prebuild_phase
    if: ${{ !cancelled() && !contains(needs.*.result, 'failure')       && github.ref != 'refs/heads/modular_testing'}}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout latest commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Restore large files
        run: |
          ls
          find . -type f -name '*.part*' | sort | while read part; do
          echo "Restoring $part"
          base=$(echo "$part" | sed 's/.part.*//')
          cat "$part" >> "$base"
          rm "$part"
          done
      - name: Start Docker Container
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker pull ghcr.io/davidblm/mxnet/190:v0.0.2
          docker run --name build-container -d -v $(pwd):/workspace --network=host  -e CI_API_V4_URL=$CI_API_V4_URL -e GITLABTOKEN=${{ secrets.GITLABTOKEN }} ghcr.io/davidblm/mxnet/190:v0.0.2 tail -f /dev/null
      - name: Script
        env:
          SCRIPT: |
            cd /workspace
            cd monticore/EmbeddedMontiArc/applications/MNISTCalculator
            python3 -m pip install -U pip
            python3 -m pip install scikit-image
            python3 -m pip install opencv-python
            cd mnist-calculator
            mvn streamtest:streamtest-build -s settings.xml -Dmaven.wagon.http.retryHandler.count=50 -Dmaven.wagon.http.connectionTimeout=6000000 -Dmaven.wagon.http.readTimeout=600000000
        run: docker exec build-container bash -c "$SCRIPT"

  TestEMADLMavenPlugin:
    needs: prebuild_phase
    if: ${{ !cancelled() && !contains(needs.*.result, 'failure')       && github.ref != 'refs/heads/modular_testing'}}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout latest commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Restore large files
        run: |
          ls
          find . -type f -name '*.part*' | sort | while read part; do
          echo "Restoring $part"
          base=$(echo "$part" | sed 's/.part.*//')
          cat "$part" >> "$base"
          rm "$part"
          done
      - name: Start Docker Container
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker pull ghcr.io/davidblm/mxnet/190:v0.0.2
          docker run --name build-container -d -v $(pwd):/workspace --network=host  -e CI_API_V4_URL=$CI_API_V4_URL -e GITLABTOKEN=${{ secrets.GITLABTOKEN }} ghcr.io/davidblm/mxnet/190:v0.0.2 tail -f /dev/null
      - name: Script
        env:
          SCRIPT: |
            cd /workspace
            cd monticore/EmbeddedMontiArc/applications/MNISTCalculator
            cd emadl-maven-plugin
            python3 -m pip install -U pip
            python3 -m pip install scikit-image
            python3 -m pip install opencv-python
            mvn dependency:resolve emadl:train -s settings.xml -U -Dmaven.wagon.http.retryHandler.count=50 -Dmaven.wagon.http.connectionTimeout=6000000 -Dmaven.wagon.http.readTimeout=600000000
            mkdir output
            python3 calculator.py
        run: docker exec build-container bash -c "$SCRIPT"
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: TestEMADLMavenPlugin
          retention-days: 1 week
          path: |
            monticore/EmbeddedMontiArc/applications/MNISTCalculator/emadl-maven-plugin/output/*

  TestModularModels:
    needs: test_phase
    if: ${{ !cancelled() && !contains(needs.*.result, 'failure') }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout latest commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Restore large files
        run: |
          ls
          find . -type f -name '*.part*' | sort | while read part; do
          echo "Restoring $part"
          base=$(echo "$part" | sed 's/.part.*//')
          cat "$part" >> "$base"
          rm "$part"
          done
      - name: Start Docker Container
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker pull ghcr.io/davidblm/mxnet/190:v0.0.2
          docker run --name build-container -d -v $(pwd):/workspace --network=host  -e CI_API_V4_URL=$CI_API_V4_URL -e GITLABTOKEN=${{ secrets.GITLABTOKEN }} ghcr.io/davidblm/mxnet/190:v0.0.2 tail -f /dev/null
      - name: Script
        env:
          SCRIPT: |
            cd /workspace
            cd monticore/EmbeddedMontiArc/applications/MNISTCalculator
            apt update && apt install -y libomp-dev
            cd mnist-modular/Streamtest
            python3 -m pip install -U pip
            python3 -m pip install scikit-image
            python3 -m pip install opencv-python
            mvn dependency:resolve emadl:train -s settings.xml -U -Dmaven.wagon.http.retryHandler.count=50 -Dmaven.wagon.http.connectionTimeout=6000000 -Dmaven.wagon.http.readTimeout=600000000
            mkdir output
            python3 calculator.py
        run: docker exec build-container bash -c "$SCRIPT"
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: TestModularModels
          retention-days: 7
          path: |
            monticore/EmbeddedMontiArc/applications/MNISTCalculator/mnist-modular/Streamtest/output/*

  TestDecomposition:
    needs: test_phase
    if: ${{ !cancelled() && !contains(needs.*.result, 'failure') }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout latest commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Restore large files
        run: |
          ls
          find . -type f -name '*.part*' | sort | while read part; do
          echo "Restoring $part"
          base=$(echo "$part" | sed 's/.part.*//')
          cat "$part" >> "$base"
          rm "$part"
          done
      - name: Start Docker Container
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker pull ghcr.io/davidblm/mxnet/190:v0.0.2
          docker run --name build-container -d -v $(pwd):/workspace --network=host  -e CI_API_V4_URL=$CI_API_V4_URL -e GITLABTOKEN=${{ secrets.GITLABTOKEN }} ghcr.io/davidblm/mxnet/190:v0.0.2 tail -f /dev/null
      - name: Script
        env:
          SCRIPT: |
            cd /workspace
            cd monticore/EmbeddedMontiArc/applications/MNISTCalculator
            export TZ=Europe/Berlin && apt update && DEBIAN_FRONTEND=noninteractive apt install -y tzdata
            apt update && apt install -y libomp-dev libopencv-dev python3-opencv
            ln -fs /usr/share/zoneinfo/Europe/Berlin /etc/localtime
            dpkg-reconfigure --frontend noninteractive tzdata
            python3 -m pip install -U pip
            python3 -m pip install scikit-image
            python3 -m pip install opencv-python
            ln /usr/bin/python3 /usr/bin/python -f
            cd mnist-modular/Streamtest
            mvn dependency:resolve -s settings.xml -U -Dmaven.wagon.http.retryHandler.count=50 -Dmaven.wagon.http.connectionTimeout=6000000 -Dmaven.wagon.http.readTimeout=600000000
            cd ../Decomposition
            ./runDecomposition.sh
            STATUS=$?
            if [[ $STATUS -eq 1 ]]; then echo "Error during decomposition." $RES; exit 1; fi;
        run: docker exec build-container bash -c "$SCRIPT"
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: TestDecomposition
          retention-days: 7
          path: |
            monticore/EmbeddedMontiArc/applications/MNISTCalculator/mnist-modular/Streamtest/output/*

  TestDecompositionResNet:
    needs: TestEMADLMavenPlugin
    if: ${{ !cancelled() && !contains(needs.*.result, 'failure') }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout latest commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Restore large files
        run: |
          ls
          find . -type f -name '*.part*' | sort | while read part; do
          echo "Restoring $part"
          base=$(echo "$part" | sed 's/.part.*//')
          cat "$part" >> "$base"
          rm "$part"
          done
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: TestEMADLMavenPlugin
          path: |
            monticore/EmbeddedMontiArc/applications/MNISTCalculator/emadl-maven-plugin/output/*
      - name: Start Docker Container
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker pull ghcr.io/davidblm/mxnet/190:v0.0.2
          docker run --name build-container -d -v $(pwd):/workspace --network=host  -e CI_API_V4_URL=$CI_API_V4_URL -e GITLABTOKEN=${{ secrets.GITLABTOKEN }} ghcr.io/davidblm/mxnet/190:v0.0.2 tail -f /dev/null
      - name: Script
        env:
          SCRIPT: |
            cd /workspace
            cd monticore/EmbeddedMontiArc/applications/MNISTCalculator
            export TZ=Europe/Berlin
            apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y tzdata libomp-dev libopencv-dev python3-opencv
            ln -fs /usr/share/zoneinfo/Europe/Berlin /etc/localtime
            dpkg-reconfigure --frontend noninteractive tzdata
            python3 -m pip install --upgrade pip
            python3 -m pip install scikit-image opencv-python
            ln -fs /usr/bin/python3 /usr/bin/python
            cd mnist-modular/DecompositionResNet
            mvn dependency:resolve emadl:train -s settings.xml -U -Dmaven.wagon.http.retryHandler.count=50 -Dmaven.wagon.http.connectionTimeout=6000000 -Dmaven.wagon.http.readTimeout=600000000
        run: docker exec build-container bash -c "$SCRIPT"

  TestTransfer:
    needs: test_phase
    if: ${{ !cancelled() && !contains(needs.*.result, 'failure') }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout latest commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Restore large files
        run: |
          ls
          find . -type f -name '*.part*' | sort | while read part; do
          echo "Restoring $part"
          base=$(echo "$part" | sed 's/.part.*//')
          cat "$part" >> "$base"
          rm "$part"
          done
      - name: Start Docker Container
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker pull ghcr.io/davidblm/mxnet/190:v0.0.2
          docker run --name build-container -d -v $(pwd):/workspace --network=host  -e CI_API_V4_URL=$CI_API_V4_URL -e GITLABTOKEN=${{ secrets.GITLABTOKEN }} ghcr.io/davidblm/mxnet/190:v0.0.2 tail -f /dev/null
      - name: Script
        env:
          SCRIPT: |
            cd /workspace
            cd monticore/EmbeddedMontiArc/applications/MNISTCalculator
            export TZ=Europe/Berlin
            apt update && DEBIAN_FRONTEND=noninteractive apt install -y tzdata libomp-dev libopencv-dev python3-opencv
            ln -fs /usr/share/zoneinfo/Europe/Berlin /etc/localtime
            dpkg-reconfigure --frontend noninteractive tzdata
            python3 -m pip install -U pip scikit-image opencv-python
            ln -fs /usr/bin/python3 /usr/bin/python
            cd transfer
            chmod +x runTransfer.sh
            ./runTransfer.sh
        run: docker exec build-container bash -c "$SCRIPT"

  TestMnistWithAdaNet:
    needs: prebuild_phase
    if: ${{ !cancelled() && !contains(needs.*.result, 'failure')       && github.ref != 'refs/heads/modular_testing'}}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout latest commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Restore large files
        run: |
          ls
          find . -type f -name '*.part*' | sort | while read part; do
          echo "Restoring $part"
          base=$(echo "$part" | sed 's/.part.*//')
          cat "$part" >> "$base"
          rm "$part"
          done
      - name: Start Docker Container
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker pull ghcr.io/davidblm/dockerimages/mxnet170:v0.0.1
          docker run --name build-container -d -v $(pwd):/workspace --network=host  -e CI_API_V4_URL=$CI_API_V4_URL -e GITLABTOKEN=${{ secrets.GITLABTOKEN }} ghcr.io/davidblm/dockerimages/mxnet170:v0.0.1 tail -f /dev/null
      - name: Script
        env:
          SCRIPT: |
            cd /workspace
            cd monticore/EmbeddedMontiArc/applications/MNISTCalculator
            mv /mxnet/build/libmxnet.so /mxnet/build/libmxnet.a /usr/lib/
            cd AdaNet
            mvn dependency:resolve emadl:train -s settings.xml -Dmaven.wagon.http.retryHandler.count=50 -Dmaven.wagon.http.connectionTimeout=6000000 -Dmaven.wagon.http.readTimeout=600000000
        run: docker exec build-container bash -c "$SCRIPT"

  TestMNISTwithCustomLayer:
    needs: prebuild_phase
    if: ${{ !cancelled() && !contains(needs.*.result, 'failure')       && github.ref != 'refs/heads/modular_testing'}}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout latest commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Restore large files
        run: |
          ls
          find . -type f -name '*.part*' | sort | while read part; do
          echo "Restoring $part"
          base=$(echo "$part" | sed 's/.part.*//')
          cat "$part" >> "$base"
          rm "$part"
          done
      - name: Start Docker Container
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker pull ghcr.io/davidblm/dockerimages/mxnet170:v0.0.1
          docker run --name build-container -d -v $(pwd):/workspace --network=host  -e CI_API_V4_URL=$CI_API_V4_URL -e GITLABTOKEN=${{ secrets.GITLABTOKEN }} ghcr.io/davidblm/dockerimages/mxnet170:v0.0.1 tail -f /dev/null
      - name: Script
        env:
          SCRIPT: |
            cd /workspace
            cd monticore/EmbeddedMontiArc/applications/MNISTCalculator
            shopt -s expand_aliases
            echo 'alias python='\''/usr/bin/python3'\''' >> ~/.bashrc
            . ~/.bashrc
            cat ~/.bashrc
            echo $PYTHONPATH
            python --version
            python3 --version
            which python
            which python3
            alias python=/usr/bin/python3
            python --version
            python3 --version
            which python
            type -a python
            mv /mxnet/build/libmxnet.so /mxnet/build/libmxnet.a /usr/lib/
            cd mnist-custom-layer
            mvn dependency:resolve emadl:train -s settings.xml -Dmaven.wagon.http.retryHandler.count=50 -Dmaven.wagon.http.connectionTimeout=6000000 -Dmaven.wagon.http.readTimeout=600000000
        run: docker exec build-container bash -c "$SCRIPT"

  TrainTensorflowONNX:
    needs: prebuild_phase
    if: ${{ !cancelled() && !contains(needs.*.result, 'failure')       && github.ref != 'refs/heads/modular_testing'}}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout latest commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Restore large files
        run: |
          ls
          find . -type f -name '*.part*' | sort | while read part; do
          echo "Restoring $part"
          base=$(echo "$part" | sed 's/.part.*//')
          cat "$part" >> "$base"
          rm "$part"
          done
      - name: Start Docker Container
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker pull ghcr.io/davidblm/dockerimages/tensorflow-onnx:latest
          docker run --name build-container -d -v $(pwd):/workspace --network=host  -e CI_API_V4_URL=$CI_API_V4_URL -e GITLABTOKEN=${{ secrets.GITLABTOKEN }} ghcr.io/davidblm/dockerimages/tensorflow-onnx:latest tail -f /dev/null
      - name: Script
        env:
          SCRIPT: |
            cd /workspace
            cd monticore/EmbeddedMontiArc/applications/MNISTCalculator
            cd onnx/tensorflow-pretrained
            mvn dependency:resolve emadl:train -s settings.xml -Dmaven.wagon.http.retryHandler.count=50 -Dmaven.wagon.http.connectionTimeout=6000000 -Dmaven.wagon.http.readTimeout=600000000
        run: docker exec build-container bash -c "$SCRIPT"
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: TrainTensorflowONNX
          retention-days: 1 
          path: |
            monticore/EmbeddedMontiArc/applications/MNISTCalculator/onnx/tensorflow-pretrained/model/

  TestGluonONNX:
    needs: TrainTensorflowONNX
    if: ${{ !cancelled() && !contains(needs.*.result, 'failure')       && github.ref != 'refs/heads/modular_testing'}}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout latest commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Restore large files
        run: |
          ls
          find . -type f -name '*.part*' | sort | while read part; do
          echo "Restoring $part"
          base=$(echo "$part" | sed 's/.part.*//')
          cat "$part" >> "$base"
          rm "$part"
          done
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: TrainTensorflowONNX
          path: |
            monticore/EmbeddedMontiArc/applications/MNISTCalculator/onnx/tensorflow-pretrained/model/
      - name: Start Docker Container
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker pull ghcr.io/davidblm/dockerimages/mxnet170-onnx:v0.0.1
          docker run --name build-container -d -v $(pwd):/workspace --network=host  -e CI_API_V4_URL=$CI_API_V4_URL -e GITLABTOKEN=${{ secrets.GITLABTOKEN }} ghcr.io/davidblm/dockerimages/mxnet170-onnx:v0.0.1 tail -f /dev/null
      - name: Script
        env:
          SCRIPT: |
            cd /workspace
            cd monticore/EmbeddedMontiArc/applications/MNISTCalculator
            mv /mxnet/build/libmxnet.so /mxnet/build/libmxnet.a /usr/lib/
            python3 -m pip install -U pip
            python3 -m pip install scikit-image
            python3 -m pip install opencv-python
            cd onnx/tensorflow-pretrained
            python3 -m pip install -U pip
            python3 -m pip install scikit-image
            python3 -m pip install opencv-python
            ls model/cNNCalculator.Network/
            mvn emadl:install-pretrained -e -s ./settings.xml -Dmaven.wagon.http.retryHandler.count=50 -Dmaven.wagon.http.connectionTimeout=6000000 -Dmaven.wagon.http.readTimeout=600000000
            cd ../gluon-load
            mvn emadl:train -s settings.xml -Dmaven.wagon.http.retryHandler.count=50 -Dmaven.wagon.http.connectionTimeout=6000000 -Dmaven.wagon.http.readTimeout=600000000
            chmod +x build.sh
            ./build.sh
            RES=$(./build/src/cpp/DigitCalculator resources/images/1.png resources/images/2.png resources/images/3.png resources/images/4.png resources/images/5.png resources/images/6.png)
            if [[ $RES != *"SUM: 579"* ]]; then echo "Wrong result:" $RES; exit 1; fi;
        run: docker exec build-container bash -c "$SCRIPT"

  DeployMnistCalcArtifact:
    runs-on: ubuntu-latest
    container:
      image: maven:3.6-jdk-8
    timeout-minutes: 60
    steps:
      - name: Checkout latest commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Restore large files
        run: |
          ls
          find . -type f -name '*.part*' | sort | while read part; do
          echo "Restoring $part"
          base=$(echo "$part" | sed 's/.part.*//')
          cat "$part" >> "$base"
          rm "$part"
          done
      - name: Script
        run: |
          cd monticore/EmbeddedMontiArc/applications/MNISTCalculator
          cd "emadl-maven_hexadecimal_calculator/trained_mnist_calc"
          

  DeployDecompositionResNetArtifact:
    needs: TestEMADLMavenPlugin
    if: ${{ !cancelled() && !contains(needs.*.result, 'failure') }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout latest commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Restore large files
        run: |
          ls
          find . -type f -name '*.part*' | sort | while read part; do
          echo "Restoring $part"
          base=$(echo "$part" | sed 's/.part.*//')
          cat "$part" >> "$base"
          rm "$part"
          done
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: TestEMADLMavenPlugin
          path: |
            monticore/EmbeddedMontiArc/applications/MNISTCalculator/emadl-maven-plugin/output/*
      - name: Start Docker Container
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker pull ghcr.io/davidblm/mxnet/190:v0.0.2
          docker run --name build-container -d -v $(pwd):/workspace --network=host  -e CI_API_V4_URL=$CI_API_V4_URL -e GITLABTOKEN=${{ secrets.GITLABTOKEN }} ghcr.io/davidblm/mxnet/190:v0.0.2 tail -f /dev/null
      - name: Script
        env:
          SCRIPT: |
            cd /workspace
            cd monticore/EmbeddedMontiArc/applications/MNISTCalculator
            export TZ=Europe/Berlin
            apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y tzdata libomp-dev libopencv-dev python3-opencv
            ln -fs /usr/share/zoneinfo/Europe/Berlin /etc/localtime
            dpkg-reconfigure --frontend noninteractive tzdata
            python3 -m pip install --upgrade pip
            python3 -m pip install scikit-image opencv-python
            ln -fs /usr/bin/python3 /usr/bin/python
            cd mnist-modular/DecompositionResNetExport
            mvn dependency:resolve -s settings.xml -U -f pom_build.xml -Dmaven.wagon.http.retryHandler.count=50 -Dmaven.wagon.http.connectionTimeout=6000000 -Dmaven.wagon.http.readTimeout=600000000
            mvn emadl:train -s settings.xml -U -f pom_build.xml -Dmaven.wagon.http.retryHandler.count=50 -Dmaven.wagon.http.connectionTimeout=6000000 -Dmaven.wagon.http.readTimeout=600000000
            
        run: docker exec build-container bash -c "$SCRIPT"

  TrainHexadecimal_MnistCalculator:
    needs: prebuild_phase
    if: ${{ !cancelled() && !contains(needs.*.result, 'failure') }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout latest commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Restore large files
        run: |
          ls
          find . -type f -name '*.part*' | sort | while read part; do
          echo "Restoring $part"
          base=$(echo "$part" | sed 's/.part.*//')
          cat "$part" >> "$base"
          rm "$part"
          done
      - name: Start Docker Container
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker pull ghcr.io/davidblm/mxnet/190:v0.0.2
          docker run --name build-container -d -v $(pwd):/workspace --network=host  -e CI_API_V4_URL=$CI_API_V4_URL -e GITLABTOKEN=${{ secrets.GITLABTOKEN }} ghcr.io/davidblm/mxnet/190:v0.0.2 tail -f /dev/null
      - name: Script
        env:
          SCRIPT: |
            cd /workspace
            cd monticore/EmbeddedMontiArc/applications/MNISTCalculator
            cd "emadl-maven_hexadecimal_calculator"
            python3 -m pip install -U pip
            python3 -m pip install scikit-image
            python3 -m pip install opencv-python
            echo "$PWD"
            cd src/main/emadl/calculator
            ls
            cd ../../../..
            mvn dependency:resolve emadl:train -s settings.xml -U -Dmaven.wagon.http.retryHandler.count=50 -Dmaven.wagon.http.connectionTimeout=6000000 -Dmaven.wagon.http.readTimeout=600000000
        run: docker exec build-container bash -c "$SCRIPT"

  TrainHexadecimal_MnistCalculatorTL:
    needs: prebuild_phase
    if: ${{ !cancelled() && !contains(needs.*.result, 'failure') }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout latest commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Restore large files
        run: |
          ls
          find . -type f -name '*.part*' | sort | while read part; do
          echo "Restoring $part"
          base=$(echo "$part" | sed 's/.part.*//')
          cat "$part" >> "$base"
          rm "$part"
          done
      - name: Start Docker Container
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker pull ghcr.io/davidblm/mxnet/190:v0.0.2
          docker run --name build-container -d -v $(pwd):/workspace --network=host  -e CI_API_V4_URL=$CI_API_V4_URL -e GITLABTOKEN=${{ secrets.GITLABTOKEN }} ghcr.io/davidblm/mxnet/190:v0.0.2 tail -f /dev/null
      - name: Script
        env:
          SCRIPT: |
            cd /workspace
            cd monticore/EmbeddedMontiArc/applications/MNISTCalculator
            cd "emadl-maven_hexadecimal_calculator_transfer_learning"
            python3 -m pip install -U pip
            python3 -m pip install scikit-image
            python3 -m pip install opencv-python
            echo "$PWD"
            mvn dependency:resolve  -s settings.xml -U -Dmaven.wagon.http.retryHandler.count=50 -Dmaven.wagon.http.connectionTimeout=6000000 -Dmaven.wagon.http.readTimeout=600000000
            mvn clean verify -s settings.xml -U -Dmaven.wagon.http.retryHandler.count=50 -Dmaven.wagon.http.connectionTimeout=6000000 -Dmaven.wagon.http.readTimeout=600000000
            mvn emadl:train -s settings.xml -U -Dmaven.wagon.http.retryHandler.count=50 -Dmaven.wagon.http.connectionTimeout=6000000 -Dmaven.wagon.http.readTimeout=600000000
            mkdir output
            python3 calculator.py
        run: docker exec build-container bash -c "$SCRIPT"

  TrainOperator_MnistCalculator:
    needs: prebuild_phase
    if: ${{ !cancelled() && !contains(needs.*.result, 'failure') }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout latest commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Restore large files
        run: |
          ls
          find . -type f -name '*.part*' | sort | while read part; do
          echo "Restoring $part"
          base=$(echo "$part" | sed 's/.part.*//')
          cat "$part" >> "$base"
          rm "$part"
          done
      - name: Start Docker Container
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker pull ghcr.io/davidblm/mxnet/190:v0.0.2
          docker run --name build-container -d -v $(pwd):/workspace --network=host  -e CI_API_V4_URL=$CI_API_V4_URL -e GITLABTOKEN=${{ secrets.GITLABTOKEN }} ghcr.io/davidblm/mxnet/190:v0.0.2 tail -f /dev/null
      - name: Script
        env:
          SCRIPT: |
            cd /workspace
            cd monticore/EmbeddedMontiArc/applications/MNISTCalculator
            cd "emadl-maven_operator_calculator"
            python3 -m pip install -U pip
            python3 -m pip install scikit-image
            python3 -m pip install opencv-python
            echo "$PWD"
            mvn dependency:resolve emadl:train -s settings.xml -U -Dmaven.wagon.http.retryHandler.count=50 -Dmaven.wagon.http.connectionTimeout=6000000 -Dmaven.wagon.http.readTimeout=600000000
            mkdir output
            python3 calculator.py
        run: docker exec build-container bash -c "$SCRIPT"

  TrainOperator_MnistCalculatorTL:
    needs: prebuild_phase
    if: ${{ !cancelled() && !contains(needs.*.result, 'failure') }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout latest commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Restore large files
        run: |
          ls
          find . -type f -name '*.part*' | sort | while read part; do
          echo "Restoring $part"
          base=$(echo "$part" | sed 's/.part.*//')
          cat "$part" >> "$base"
          rm "$part"
          done
      - name: Start Docker Container
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker pull ghcr.io/davidblm/mxnet/190:v0.0.2
          docker run --name build-container -d -v $(pwd):/workspace --network=host  -e CI_API_V4_URL=$CI_API_V4_URL -e GITLABTOKEN=${{ secrets.GITLABTOKEN }} ghcr.io/davidblm/mxnet/190:v0.0.2 tail -f /dev/null
      - name: Script
        env:
          SCRIPT: |
            cd /workspace
            cd monticore/EmbeddedMontiArc/applications/MNISTCalculator
            cd "emadl-maven_operator_calculator_transfer_learning"
            python3 -m pip install -U pip
            python3 -m pip install scikit-image
            python3 -m pip install opencv-python
            echo "$PWD"
            mvn dependency:resolve  -s settings.xml -U -Dmaven.wagon.http.retryHandler.count=50 -Dmaven.wagon.http.connectionTimeout=6000000 -Dmaven.wagon.http.readTimeout=600000000
            mvn clean verify -s settings.xml -U -Dmaven.wagon.http.retryHandler.count=50 -Dmaven.wagon.http.connectionTimeout=6000000 -Dmaven.wagon.http.readTimeout=600000000
            mvn emadl:train -s settings.xml -U -Dmaven.wagon.http.retryHandler.count=50 -Dmaven.wagon.http.connectionTimeout=6000000 -Dmaven.wagon.http.readTimeout=600000000
            mkdir output
            python3 calculator.py
        run: docker exec build-container bash -c "$SCRIPT"

